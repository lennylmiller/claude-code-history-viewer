name: Issue Analysis & PR Setup

on:
  issues:
    types: [opened, labeled]

jobs:
  analyze-and-setup:
    # 'ready' ë¼ë²¨ì´ ë¶™ì—ˆì„ ë•Œë§Œ ì‹¤í–‰
    if: contains(github.event.issue.labels.*.name, 'ready')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write
      pull-requests: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Analyze Issue & Create Branch
        id: analyze
        uses: actions/github-script@v7
        with:
          script: |
            const issue = context.payload.issue;

            // ì´ìŠˆ ì •ë³´ ì¶”ì¶œ
            const issueNumber = issue.number;
            const issueTitle = issue.title;
            const issueBody = issue.body || '';

            // ë¸Œëœì¹˜ëª… ìƒì„± (ì´ìŠˆ ë²ˆí˜¸ + ì œëª© slug)
            const slug = issueTitle
              .toLowerCase()
              .replace(/[^a-z0-9]+/g, '-')
              .replace(/^-|-$/g, '')
              .substring(0, 40);
            const branchName = `issue-${issueNumber}-${slug}`;

            // ì¹´í…Œê³ ë¦¬ ìë™ ê°ì§€
            let category = 'enhancement';
            const titleLower = issueTitle.toLowerCase();
            const bodyLower = issueBody.toLowerCase();

            if (titleLower.includes('bug') || titleLower.includes('fix') || bodyLower.includes('error')) {
              category = 'bugfix';
            } else if (titleLower.includes('feat') || titleLower.includes('add')) {
              category = 'feature';
            } else if (titleLower.includes('doc') || titleLower.includes('readme')) {
              category = 'docs';
            } else if (titleLower.includes('refactor')) {
              category = 'refactor';
            }

            // PR í…œí”Œë¦¿ ìƒì„±
            const prBody = `## ê´€ë ¨ ì´ìŠˆ
Closes #${issueNumber}

## ì´ìŠˆ ìš”ì•½
**ì œëª©:** ${issueTitle}

**ì›ë¬¸:**
${issueBody}

---

## ì‘ì—… ì²´í¬ë¦¬ìŠ¤íŠ¸
- [ ] ìš”êµ¬ì‚¬í•­ ë¶„ì„ ì™„ë£Œ
- [ ] êµ¬í˜„ ì™„ë£Œ
- [ ] í…ŒìŠ¤íŠ¸ ì™„ë£Œ
- [ ] ë¬¸ì„œ ì—…ë°ì´íŠ¸ (í•„ìš”ì‹œ)

## êµ¬í˜„ ë…¸íŠ¸
<!-- Claude Codeê°€ ë¶„ì„í•œ ë‚´ìš©ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->

---
ğŸ¤– Auto-generated from issue #${issueNumber}
`;

            core.setOutput('branch_name', branchName);
            core.setOutput('issue_number', issueNumber);
            core.setOutput('issue_title', issueTitle);
            core.setOutput('issue_body', issueBody);
            core.setOutput('category', category);
            core.setOutput('pr_body', prBody);

      - name: Create Branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git checkout -b ${{ steps.analyze.outputs.branch_name }}
          git push origin ${{ steps.analyze.outputs.branch_name }}

      - name: Create Draft PR
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `[#${{ steps.analyze.outputs.issue_number }}] ${{ steps.analyze.outputs.issue_title }}`,
              body: `${{ steps.analyze.outputs.pr_body }}`,
              head: '${{ steps.analyze.outputs.branch_name }}',
              base: 'main',
              draft: true
            });

            // ì´ìŠˆì— ì½”ë©˜íŠ¸ ì¶”ê°€
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: ${{ steps.analyze.outputs.issue_number }},
              body: `ğŸš€ **ì‘ì—… í™˜ê²½ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤!**

**ë¸Œëœì¹˜:** \`${{ steps.analyze.outputs.branch_name }}\`
**Draft PR:** #${pr.number}

\`\`\`bash
# ë¡œì»¬ì—ì„œ ì‘ì—… ì‹œì‘
git fetch origin
git checkout ${{ steps.analyze.outputs.branch_name }}

# Claude Codeë¡œ ì‘ì—…
claude "ì´ìŠˆ #${{ steps.analyze.outputs.issue_number }} ì‘ì—… ì‹œì‘"
\`\`\`
`
            });

            console.log(`Created draft PR #${pr.number}`);
